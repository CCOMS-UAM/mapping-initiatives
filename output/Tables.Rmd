---
title: "Tables"
output:
  officedown::rdocx_document:
    base_format:     bookdown::word_document2
    reference_docx:  ../www/APA_6th_edition_template.docx
    fig_width:       6.73
    fig_asp:          .75
    number_sections: no
    tables:
      layout:        autofit
      caption:
        sep: '. '
    keep_md:         no
bibliography:        ../www/Mapping_initiatives.bib
csl:                 ../www/apa-old-doi-prefix.csl
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Environment setup:

gc()

# Libraries:
library(knitr)
library(tidyverse)
library(readxl)
library(vctrs)
library(gtsummary)
library(flextable)

# Constants:
DOC_DIR      <- getwd()
ROOT_DIR     <- ".."
SRC_DIR      <- "src"
SRC_FILEPATH <- file.path(SRC_DIR, "<TODO: Complete when necessary>.R")

# Knitr configuration:

opts_knit$set(root.dir = ROOT_DIR) # Interferes with officedown!
opts_chunk$set(
  echo       = FALSE,
  results    = 'hide',
  message    = FALSE,
  warning    = FALSE,
  cache      = TRUE,
  autodep    = TRUE,
  dpi        = 300,
  fig.retina = 1,
  tab.topcaption = TRUE,
  dev.args   = list(png = list(type = "cairo"))
)


# Output formatting options:

theme_gtsummary_compact()
# theme_gtsummary_printer(print_engine = "flextable")

set_flextable_defaults(font.family = "Times New Roman")
```

```{r includes}
source("R/Constants.R", encoding = 'UTF-8')
```

```{r load-chunks, cache=FALSE}
## TODO: Evaluate if necessary
# SRC_FILEPATH %>% read_chunk()
```

```{r load-data}
# N.B.: Correspondence with the generating dataset
#   (see `notebook/Update_initiatives.Rmd`, result is stored in object
#   `mica_data_complete`) has been checked. The differences are due to trailing
#   whitespaces and end of line (\n) characters, which are trimmed off when
#   reading with `readxl::read_excel()`.

tab1_new <- read_excel(
  INITIATIVES_FILEPATH,
  sheet = UPDATED_TABLE_SHEET
  # col_types = "text",
  # na    = c("NA", "na"),
  # skip  = 1
)

# Cast to proper vector types (easier than specifying all column types above):
tab1_new <- tab1_new |> mutate(
  across(methodology.moreCohortsToBeHarmonized, parse_logical)
)

# Simplify variable names
tab1_new <- tab1_new |>
  rename_with(str_remove, pattern = "methodology.") |>
  rename_with(str_remove, pattern = "nb")           |>
  rename_with(tolower)

# Reorder variables
tab1_new <- tab1_new |> select(
  id:region,
  countries,
  n_countries,
  description:participants.harmonized,
  age_range,
  everything()
)
```

```{r assign-headers}
# Get the names from the first two rows of the file, and create names and labels
tab1_data_header <- read_excel(
  INITIATIVES_FILEPATH,
  sheet = TABLE_1_SHEET,
  n_max = 1
)                                                                             |>
  pivot_longer(everything(), names_to = "header", values_to = "subheader")    |>
  mutate(
    header = header                          |>
      str_detect(AUTO_VARNAME_PREFIX_REGEXP) |>
      if_else(header |> dplyr::lag(1), header)
  )                                                                           |>
  # Add additional rows not present in the original Table 1
  add_row(header = "Initiative", subheader = "Acronym", .before = 1)          |>
  add_row(
    header    = "Age range" |> rep(2),
    subheader = c("Minimum", "Maximum"),
    .after    = 10
  )                                                                           |>
  add_row(header = c("Countries", "NÂº of countries"), .after = 3)             |>
  # Edit headers to correspond to the new structure
  mutate(
    subheader = if_else(header == "INITIATIVE", "Name", subheader),
    header    = if_else(header == "INITIATIVE", "Initiative", header),
    header    = if_else(header == "Region, Country", "Region", header),
    header    = if_else(header == "Main objective", "Description", header),
    header    = if_else(
      header |> str_detect("^Briefly"),
      "Cohort criteria",
      header
    ),
  )                                                                           |>
  unite("label", header, subheader, sep = ": ", na.rm = TRUE, remove = FALSE) |>
  # Reorder according to new structure
  slice(-15)# |>
  # mutate( # TODO: Decide if is necessary
  #   subheader = subheader |> coalesce(header),
  # )

# Make correspondences between the headers read and the existing variables:
tab1_data_header <- tab1_data_header |>
  add_column(var_name = colnames(tab1_new)[-1])

tab1_data_header |> pwalk(
  \(label, header, subheader, var_name) {
    
    attr(tab1_new[[var_name]], "label")     <<- label
    attr(tab1_new[[var_name]], "header")    <<- header
    attr(tab1_new[[var_name]], "subheader") <<- subheader
  }
)
```

```{r descriptive-table}
## TODO: Continue here
tab1_new |> select(where(is.numeric), where(is.logical)) |> tbl_summary()
```


# References

::: {#refs}
:::

\newpage

```{r set-flextable-wd, cache=FALSE}
# Necessary for flextable to find the csl file:
opts_knit$set(root.dir = DOC_DIR)
```

```{r initiatives, tab.id="initiatives", tab.cap="Descriptive information of the initiatives included in the mapping.", results='asis', cache=FALSE, eval=FALSE}
initiatives_table_output
```

\newpage

```{r descriptives, tab.id="descriptives", tab.cap="Descriptive statistics of the initiatives mapped.", results='asis', cache=FALSE, eval=FALSE}
descriptives_table_output
```

```{r reset-root-dir, cache=FALSE}
# Necessary for officedown to find the template file:
opts_knit$set(root.dir = ROOT_DIR)
```
